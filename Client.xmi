#include "Global.xm"
#include "HBTSStatusBarView.mm"

#import <Foundation/NSDistributedNotificationCenter.h>
#import <UIKit/UIApplication+Private.h>
#import <UIKit/UIStatusBarForegroundView.h>

#pragma mark - Constructor

%ctor {
	prefsBundle = [[NSBundle bundleWithPath:@"/Library/PreferenceBundles/TypeStatus.bundle"] retain];

	CFNotificationCenterAddObserver(CFNotificationCenterGetDarwinNotifyCenter(), NULL, (CFNotificationCallback)HBTSLoadPrefs, CFSTR("ws.hbang.typestatus/ReloadPrefs"), NULL, 0);

	[[NSNotificationCenter defaultCenter] addObserverForName:UIApplicationDidFinishLaunchingNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification *notification) {
		UIStatusBarForegroundView *foregroundView = MSHookIvar<UIStatusBarForegroundView *>([UIApplication sharedApplication].statusBar, "_foregroundView");

		if (!foregroundView) {
			NSLog(@"TypeStatus: uh oh. no foregroundView. bailing out.");
			return;
		}

		overlayView = [[HBTSStatusBarView alloc] initWithFrame:foregroundView.frame];
		[[UIApplication sharedApplication].statusBar addSubview:overlayView];

		HBTSLoadPrefs();

		[[NSDistributedNotificationCenter defaultCenter] addObserverForName:HBTSClientSetStatusBarNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification *notification) {
			BOOL typing = ((NSNumber *)notification.userInfo[kHBTSMessageIsTypingKey]).boolValue;

			if ([[NSDate date] timeIntervalSinceDate:notification.userInfo[kHBTSMessageSendDateKey]] > (typing && !typingTimeout ? kHBTSTypingTimeout : overlayDuration)) {
				return;
			}

			[overlayView showWithType:(HBTSStatusBarType)((NSNumber *)notification.userInfo[kHBTSMessageTypeKey]).intValue name:notification.userInfo[kHBTSMessageSenderKey] timeout:typing && !typingTimeout ? kHBTSTypingTimeout : overlayDuration];
		}];
	}];
}
